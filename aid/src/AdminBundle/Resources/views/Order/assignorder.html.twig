{% extends "AdminBundle::Layout/adminlayout.html.twig" %}
{% block title %} Assign Order {% endblock %}
{% block css %}
<link href="{{asset('bundles/design/')}}plugins/timepicker/bootstrap-timepicker.min.css" rel="stylesheet" type="text/css" />
<link href="{{asset('bundles/design/')}}plugins/datepicker/datepicker3.css" rel="stylesheet" type="text/css" />
{% endblock %}
{% block content %}
	  
	<section class="content-header" >
		  <h1>Order
		  <small></small>
		</h1>
		<ol class="breadcrumb">
		  <li><a href="{{path('admin_dashboard_index',{'domain':app.session.get('domain')})}}"><i class="fa fa-dashboard"></i>Dashboard</a></li>
		  <li class="active">Assign order</li>
		</ol>
	  </section>
	  <section class="content">
		<div class ="row">
			<div class="col-md-12">
			{% for flashMessage in app.session.flashbag.get('success_msg') %}
			  <div class="alert alert-success alert-dismissable">
				  <button aria-hidden="true" data-dismiss="alert" class="close" type="button">×</button>
				  <h4><i class="icon fa fa-check"></i> Alert!</h4>{{ flashMessage }}
			  </div>
			  {% endfor %}
			  {% for flashMessage in app.session.flashbag.get('error_msg') %}
			  <div class="alert alert-danger alert-dismissable">
				  <button aria-hidden="true" data-dismiss="alert" class="close" type="button">×</button>
				  <h4><i class="icon fa fa-check"></i> Alert!</h4>{{ flashMessage }}
			  </div>
			{% endfor %}
			</div>  
		</div>	
		<div class="row">
			<div class="col-xs-12">
                <div class="box box-solid">
                    <div class="box-header with-border">
                      <h3 class="box-title">Assign order</h3>
                      <a href="{{path('admin_order_index',{'domain':app.session.get('domain')})}}" class="btn btn-primary btn-flat pull-right"><i class="glyphicon glyphicon-chevron-left"></i><b>&nbsp;&nbsp;Back</b></a>
                      <!--<div class="pull-right">
                        <a href="{{path('admin_company_addcompany',{'domain':app.session.get('domain')})}}" class="btn btn-primary btn-flat"><i class="fa fa-plus"></i>&nbsp;&nbsp;ADD</a>
                      </div>-->
                    </div>
					
                    <div class="box-body">
						<div class="row">
							  <input type="hidden" name="status_id" id="status_id" value="{% if status_id is defined and status_id is not empty %}{{status_id}}{% endif %}" class="form-control" >
							  <div class="col-md-6">
							  <div class="box box-warning box-solid">
								<div class="box-body">
									<div class="col-md-6 bootstrap-datepicker">
										  <div class="form-group">
												<label>Select Delivery Date</label>
												<input type="text" name="date" id="date" value="{% if delivery_date is defined and delivery_date is not empty %}{{delivery_date}}{% else %}{{ "now"|date("Y-m-d") }}{% endif %}" class="checkvali form-control" >
										  </div>
									</div>
									<div class="col-md-6 bootstrap-timepicker">
										  <div class="form-group">
												<label>Select Delivery Time</label>
												<input type="text" name="time" id="time" value="{% if delivery_time is defined and delivery_time is not empty %}{{delivery_time|date("h:i A")}}{% else %}{{ "now"|date("h:i A") }}{% endif %}" class="checkvali form-control">
										  </div>
									</div>
								</div>
							  </div>
							  </div>
						</div>
						<div class="row">
							  <div class="container-fluid table-responsive">
								  <table id="example1" class="table table-bordered table-striped text-center">
									  <thead>
										  <th>No</th>
										  <th>AID Man Name</th>
										  <th>Area</th>
										  <th>Action</th>
									  </thead>
									  <tbody>
										  {% if user_list is defined and user_list is not empty %}
												{% for user in user_list %}
												<tr>
													  <td>{{loop.index}}</td>
													  <td>{{user.user_firstname}} {{user.user_lastname}}</td>
													  <td>{{area}}</td>
													  <td>
															<button type="button" class="btn {% if user.user_master_id == delivery_boy_id %}btn-success{% else %}btn-danger{% endif %} btn-xs assign_order" data-loading-text="<i class='fa fa-circle-o-notch fa-spin'></i> Loading..." value="{{user.user_master_id}}">
															{% if user.user_master_id == delivery_boy_id %}Assigned{% else %}Not assigned{% endif %}</button>
													  </td>
												</tr>
												{% endfor %}
										  {% endif %}
									  </tbody>
									  <tfoot>
										  <th>No</th>
										    <th>AID Man Name</th>
										  <th>Area</th>
										  <th>Action</th>
									  </tfoot>
								  </table>
							  </div>
						</div>
                    </div>
                  </div>
            </div>
		</div>
	  </section>
{% endblock %}

{% block js %}
<script src="{{asset('bundles/design/')}}plugins/datepicker/bootstrap-datepicker.js" type="text/javascript"></script>
<script src="{{asset('bundles/design/')}}plugins/timepicker/bootstrap-timepicker.min.js" type="text/javascript"></script>
<script>

$('.assign_order').on('click', function(){
	  var $this = $(this);
	  var date = $("#date").val();
	  var time = $("#time").val();
	  var status_id = $("#status_id").val();
	 
	  
	  var d = new Date();
	  var time_new = d.toLocaleTimeString();
	  var date_new = d.toLocaleDateString();

	  //alert($.now());
	  
	  if (status_id !="" && status_id == '10') {
		  if (date != "" && time != "" && date != "0000-00-00")
			{
	  
				  $this.text("Assigned");
				  $this.button('loading');
				  console.log({"order_id":"{{order_id}}","user_master_id":$this.val(),"date":date,"time":time,"flag":"assign_order"});
				  $.ajax({
					type: 'POST',
					url : "{{path('admin_order_assigndeliveryboy',{'domain':app.session.get('domain')})}}",
					data: {"order_id":"{{order_id}}","user_master_id":$this.val(),"date":date,"time":time,"flag":"assign_order"},
					dataType: 'json',
					success: function(response){
						$(".assign_order").removeClass("btn-success").addClass("btn-danger").text("Not assigned");
						$this.button('reset');
						$("#status_id").val('1');
						$this.removeClass("btn-danger").addClass("btn-success");
						$this.button('reset');
						console.log("success");
					}
				});
	  
			}
			else
			{
				  alert("Please select date & time");
			}
	  }else if(status_id !="" && status_id == '5') {
			alert("Order already Canceled by user.");
	  }
	  else{
			alert("Order already assigned.");
	  }
	  
	
});
$(document).ready(function() {
    $('#example1').DataTable();
} );
$(document).ready(function(){
	//Datepicker
	$("#date").datepicker({
	format: 'yyyy-mm-dd',
	showMeridian: true,
	startDate: new Date(),
	setDate:new Date()
  });
	


  //Timepicker
  $("#time").timepicker({
	showInputs: false,
	showMeridian: true,
	 'minTime': '2:00pm',
    'maxTime': '11:30pm',
  });
  function formatAMPM(date) {
		var hours = date.getHours();
		var minutes = date.getMinutes();
		var ampm = hours >= 12 ? 'pm' : 'am';
		hours = hours % 12;
		hours = hours ? hours : 12; // the hour '0' should be '12'
		minutes = minutes < 10 ? '0'+minutes : minutes;
		var strTime = hours + ':' + minutes + ' ' + ampm;
		return strTime;
   }
   
  var currentdate = new Date();
  var datetimenew = "" + currentdate.getFullYear() + "-"
                + (currentdate.getMonth()+1)  + "-" 
                + currentdate.getDate() ;
  
   $(".checkvali").change(function () {
	  var startDate = document.getElementById("time").value;
	  if (startDate == '') {
        startDate = "00 : 00 AM";
      }
	  var startselectedDate = document.getElementById("date").value;
	  startDate1 = startselectedDate +" "+startDate ;
	  var datetime = formatAMPM(currentdate);
	  datetime1 = datetimenew + " " + datetime;	
	 if ((Date.parse(startDate1) < Date.parse(datetime1))) {
	  alert("Delivery Time should be greater than Current  time");
	 document.getElementById("time").value = "";
} });
});
</script>
{% endblock %}